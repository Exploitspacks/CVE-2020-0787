# CVE-2020-0787
Vulnerability: CVE-2020-0787 (Published: March 10, 2020) Supported versions: Vista/2008/W7/2008R2/W8/2012/W8.1/2012R2/W10/2016/2019 Supported architecture: x86/x64 Development stage: v1.0.20130 (stable) Code size: 36Kb


-------------------------------------------------------------------------------------------------------
LPE exploit CVE-2020-0787 and Usermode Rootkit

1. The main characteristics of the exploit:

Vulnerability: CVE-2020-0787 (Published: March 10, 2020)
Supported versions: Vista/2008/W7/2008R2/W8/2012/W8.1/2012R2/W10/2016/2019
Supported architecture: x86/x64
Development stage: v1.0.20130 (stable)
Code size: 36Kb


2. Description and operation

The exploit is based on a vulnerability in the Windows Background Intelligent Transfer Service (BITS) service on the entire current line of systems.
The exploit can be run under User rights, and the executable module (more on that later) elevates them to SYSTEM. Remote launch via RDP is also possible.
There is a POC on the network for this vulnerability, which has no practical benefit in terms of system coverage and robust launch,
but it can be recommended for studying the principles of the vulnerability itself.

The exploit is built on a two-component basis: a launcher and an executor.
The launching module is actually the exploit of the vulnerability. It is intended for writing the executive module to the system folder.
The exploit itself does not lead to code execution, its role is only to write to the system folder.
Of particular interest is the executive module, which is a pseudo-system dll that is loaded by various
Windows services at startup. By its properties, this is nothing more than a Usermode Rootkit, developed by me from scratch and not sold anywhere before.
In this exploit, the rootkit has 3 modes of operation:
1) Launching a CMD window with SYSTEM rights.
2) Launch payload from local disk.
3) Execution of a custom command of the cmd.exe interpreter (for example, adding an admin to the system, backshell, etc.)
Because source codes are included, you can build your own functionality.

2. Additional features

   Because exploit contains a separate executable module, then even if some kind of failure occurs during startup and the module is written but
   not executed, it goes into delayed start mode. Those. the first launch of the system service (in the current session or after reboot)
   is guaranteed to launch the executable module with the necessary settings. The rootkit has 10 different independent launch methods,
   which are cyclically executed until success is achieved. These methods are different for different versions of Windows.
   In this implementation, the exploit removes the executable module (rootkit) after a successful launch, i.e. autoload functions after reboot work until
   first successful launch. The probability of successfully launching the exploit in interactive mode (without reloading) is about 90%.
   Having the source code, the buyer will be able to unlock the full potential of the exploit and turn it into a good engine for a usermod rootkit,
   those. remove the self-removal of the module and leave it in the system as a permanent loader that can start the payload at system startup.
   Even if the system is patched from the vulnerability, the rootkit will continue to work and run your code with SYSTEM rights.

3. Restrictions

Vulnerability CVE-2020-0787 has restrictions on launching from under the guest account (Guest) and from under Low Integrity. In these modes, the exp does not start.

4. Recommendations for launching and testing

The exploit execution time can vary from a few seconds to a minute, depending on the services currently loaded.
The exploit runs in two phases: writing the rootkit to the system directory and executing the rootkit.
The first phase passes quickly (if the system is vulnerable) and usually without failures. The second phase depends on the so-called system triggers.
These are services that, when they start, load a previously recorded rootkit. There may be nuances here. predict their state at the moment
the exploit cannot be launched. Therefore, there are many triggers (currently five) that are fired in turn.
In most cases, the launch of one of the triggers takes place within the first minute. But in about 3-5% of cases, the trigger does not fire or
has already been launched before. Then the rootkit will be loaded later or during the reboot. After a successful operation, the rootkit (dll) deletes itself.
If runsys.exe is running (without displaying progress), you can view its status using Process Explorer.
On some systems, services used as triggers are not unloaded after startup or are unloaded after a long time,
therefore, on such systems, the exploit after a restart may not work, a reboot is required, or a long wait until
services will be unloaded.

There are three launch options:
1) runsys.exe without parameters - a visual cmd window will start with system rights
2) runsys.exe <payload.exe> ​​the same as in the first case, but with the launch of your payload
3) runsys.exe <cmd.exe <params_list>> the same as in the first case, but with the execution of the cmd command
For example: runsys.exe "cmd.exe /c net user coolhacker 1234!5678 /add & net localgroup Administrators coolhacker /add"

The runsysO.exe module differs from runsys.exe in that it has a progress console output, runsys.exe
https://satoshidisk.com/pay/CEidVZ
---------------------------------------------------------------------------------------------------------

LPE эксплоит CVE-2020-0787 и Usermode Rootkit

1. Основные характеристики эксплоита:

Vulnerability: CVE-2020-0787 (Published: March 10, 2020)
Supported versions: Vista/2008/W7/2008R2/W8/2012/W8.1/2012R2/W10/2016/2019
Supported architecture: x86/x64
Development stage: v1.0.20130 (stable)
Code size: 36Kb


2. Описание и работа
	
	Эксплоит построн на уязвимости в Windows Background Intelligent Transfer Service (BITS) сервисе на всей актуальной линейке систем.
	Эксплоит может запускаться под правами User а исполнительный модуль (о нем далее) подымает их до SYSTEM. Возможен также удаленный запуск через RDP.
	В сети имеется POC на данную уязвимость, который не имеет практической пользы в плане охвата систем и устойчиого запуска,
	но зато может быть рекомендован для изучения принципов самой уязвимости.
	
	Эксплоит построен на двухкомпонентной основе: запускающий модуль и исполнительный модуль.
	Зщапускающий модуль это собственно эксплоит уязвимости. Он преднозначен для записи исполнительного модуля в системную папку.
	Сам по себе эксплоит не приводит к выполнению кода, его роль только запись в системную папку.
	Особый интерес представляет исполнительный модуль, который представляет из себя псевдосистемную длл, которую загружают различные
	Windows сервисы при своем запуске. По своим свойствам это ничто иное как Usermode Rootkit, разработанный мною с нуля и нигде ранее не продававшийся.
	В данном эксплоите руткит имеет 3 режима работы:
	1) Запуск окна CMD с правами SYSTEM.
	2) Запуск полезной нагрузки с локального диска.
	3) Выполнение пользовательской команды интерпретатора cmd.exe (например добавление админа в систему, бэкшелл и т.д.)
	Т.к. исходники идут в комплекте, можно построить свой собственный функционал.

2. Дополнительные особенности

   Т.к. эксплоит содержит отдельный исполнительный модуль, то даже если при запуске произойдет какой-то сбой и модуль будет записан но
   не исполнен, то он переходит в режим отложенного запуска. Т.е. первый же запуск системного сервиса (в текущей сессии или после ребута)
   гарантированно запустит исполнительный модуль с необходимыми настройками. Руткит имеет 10 различных независимых способов запуска,
   которые циклически исполняются пока не будет достигнут успех. Эти способы различны для разных версий Windows.
   В данной реализации эксплоит удаляет исполнительный модуль(руткит) после успешного запуска, т.е. функции автозагрузки после ребута работают до
   первого успешного запуска. Вероятность успешного запуска эксплоита в интерактивном режиме (без перегрузки) около 90%.
   Имея исходники, покупатель сможет раскрыть весь потенциал эксплоита и превратить его в хороший движок для юзермодного руткита,
   т.е. убрать самоудаление модуля и оставить его в системе как постоянный загрузчик, который сможет стартовать полезную нагрузку при старте системы.
   Даже если система будет пропатчена от уязвимости, руткит будет продолжать работу и запускать ваш код c правами SYSTEM.

3. Ограничения

	Уязвимость CVE-2020-0787 имеет огранияения по запуску из под гостевой учетки (Guest) и из под Low Integrity. В этих режимах эксп не запускается.

4. Рекомендации по запуску и тестированию

	Время исполнения эксплоита может колебаться от нескольких секунд до минуты в зависимости от сервисов загруженных в данный момент.
	Эксплоит выполняется в двух фазах: запись  руткита в сиистемную папку и исполнение руткита.
	Первая фаза проходит быстро (если система уязвима) и как правило без сбоев. Вторая фаза зависит от так называемых системных триггеров.
	Это сервисы, которые при своем запуске подгружают записанный ранее руткит. Тут могут быть нюансы т.к. предугадать их состояние в момент
	запуска эксплоита невозможно. Поэтому используется множество триггеров (в данный момент пять) которые поочередно запускаются.
	В большинстве случаев запуск одного из триггеров проходит в течении первой минуты. Но в примерно 3-5% случаев триггер не запускается или
	уже был запущен ранее. Тогда руткит будет подгружен позднее или во время перезагрузки. После успешного срабатывания руткит (длл) самоудаляется.
	Если запускается runsys.exe (без вывода хода выполнения) наблюдать его состояние можно с помощью Process Explorer.
	На некоторых системах сервисы, используемые в качестве триггеров не выгружаются после запуска или выгружаются спустя долгое время,
	поэтому на таких системах эксплоит после повторного запуска может не сработать, тебуется перезагрузка, либо длительное ожидание пока
	сервисы выгрузятся.
	
	Параметров запуска может быть три:
	1) runsys.exe без параметров - запустится визуальное окно cmd с правами system
	2) runsys.exe <payload.exe> то же что в первом случае, но с запуском вашей полезной нагрузки
	3) runsys.exe <cmd.exe <params_list>> то же что в первом случае, но с выполнением команды cmd
	Например: runsys.exe "cmd.exe /c net user coolhacker 1234!5678 /add & net localgroup Administrators coolhacker /add"
	
	Модуль runsysO.exe отличается от runsys.exe нааличием консольного вывода хода работы, runsys.exe выполняется незаметно (вывод визуальной
	консоли cmd можно убрать в исходниках, закоментировав строку #define CMDSYS в хедере main.h руткита pb_dll
	
	В папке Tools  содержится криптованный вариант эксплоита для тестов проактивки. Запускать нужно starter32.exe (см. п5)
	
5. Обход  проактивной защиты
	
	Эксплоит проверен на некоторых проактивках:

	• KIS 20.0.14.1085
	• Avast IS 2019
	• ESET Smart Security 11
	(возможны проверки на других проактивках по запросу)

	Видео работы на W10 19H2 (обновления по февраль 2020) x64 + KIS 20.0.14.1085:
	https://youtu.be/_Ukmk4tstkk
	
	Особая просьба не сливать некриптованные самплы, для тестов на проактивках есть криптованный вариант эксплоита starter32.exe
	Он запускается с такими же командами как и runsys.exe. Рядом, в папке обязательно должен лежать runsys.cr
	
6. Комплектация

	* C++ исходники запускающего модуля и эксплоита
	* C++ исходники исполнительного модуля (руткита) pb_dll
	* Откомпилированные бинарники

7.  Состав проекта

	Проект состоит из двух частей. Первая, основная это запускающий модуль. Вторая (pb_dll) - руткит.
	Запускающий модуль содержит в себе код эксплоита и бинарники руткита. Его задача выполнить эксплоит , записать руткит в системную папку и
	выполнить системный триггер. Бинарники руткита содержаться в хедере dll.h 
	В отладочном режиме DEBUG вывод происходит в консоль и в окно дебаггера.
	Откомпилированные бинарники главного модуля runsys.exe и runsysO.exe лежат в папке bin_rtm
	Бинарники руткита (dll32.dll и dll64.dll) лежат в папке pb_dll\bin_rtm
	Также, в папке Tools находятся криптованные бинарники runsys.cr и runsysO.cr, там же
	запускающие их модули starter32.exe и starter32О.exe  (запускаются с теме же параметрами как и runsys.exe/runsysO.exe)
	Проект собирался в 2019 студии.
	
8. Техподдержка

	Багфиксы и техподдержка как всегда идут в комплекте.
	

-------------------------------------------------------------------------------------------------------------------------
https://satoshidisk.com/pay/CEidVZ
